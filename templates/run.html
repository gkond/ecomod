{% extends "base.html" %}

{% block title %}All Models{% endblock %}

{% block head %}
    {{ super() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.12/handlebars.min.js"></script>
    <script>
        {#var commands = [#}
        {#    "start_day",#}
        {#    "number_of_days",#}
        {#    "exe_models",#}
        {#    "change_input_series_one_model",#}
        {#    "change_input_series_all_models",#}
        {#    "change_timeseries_value_several_days",#}
        {#    "change_timeseries_value_several_days_add_delta"#}
        {#];#}
        var state = {{ state|tojson }};
        var models = {{ models|tojson }};

        /*
        function getModels() {
            return models.map(function (model) {
                return {
                    id: model.model_system_name,
                    name: model.model_name_user + ":" + model.author
                }
            })
        }
        */

        function getInputs(model_ids) {
            if (!model_ids) {
                model_ids = models.map(function (model) {
                    return model.model_system_name
                });
            }

            return models.filter(function (model) {
                return model_ids.includes(model.model_system_name)
            }).map(function (model) {
                return Object.keys(model.inputs).map(function (input) {
                    return model.inputs[input];
                });
            }).reduce(function (acc, model) {
                return acc.concat(model);
            }, []);
        }

        console.log(getInputs('model_0'))

        /*
        function getStartDay(formData) {
            var command = formData.find(function (item) {
                return item.name === "start_day"
            });
            return {
                "command": "start_day",
                "start_day": command.value
            }
        }

        function getNumberOfDays(formData) {
            var command = formData.find(function (item) {
                return item.name === "number_of_days"
            });
            return {
                "command": "number_of_days",
                "number_of_days": command.value
            }
        }

        function getExeModels(formData) {
            var commands = formData.filter(function (item) {
                return item.name === "exe_models"
            }).map(function (item) {
                return item.value;
            });
            return {
                "command": "exe_models",
                "include": commands
            }
        }

        function constructCommands(formData) {
            var commands = [];
            commands.push(
                getStartDay(formData),
                getNumberOfDays(formData),
                getExeModels(formData)
            );

            console.log(formData);
            console.log(commands);
            return commands;
        }*/

        function renderForm(state) {
            clearForm();
            appendStartDay(state);
            appendNumberOfDays(state);
            appendExeModels(state);
            appendChangeInputSeriesOneModel(state);
            appendChangeInputSeriesAllModels(state);
            appendChangeTimeseriesValueForSeveralDays(state);
            appendChangeTimeseriesValueForSeveralDaysAddDelta(state);
        }

        function clearForm() {
            $("#form_commands").empty();
        }

        function appendToForm(template, context) {
            var templateFn = Handlebars.compile(
                $("[data-template=" + template + "]").html()
            );
            var html = templateFn(context);
            $("#form_commands").append(html);
        }

        function appendStartDay(state) {
            var id = "start_day";
            var command = state.find(function (command) {
                return command.command === id
            });
            appendToForm(id, {value: command[id]})
        }

        function appendNumberOfDays(state) {
            var id = "number_of_days";
            var command = state.find(function (command) {
                return command.command === id
            });
            appendToForm(id, {value: command[id]})
        }

        function appendExeModels(state) {
            var id = "exe_models";
            var command = state.find(function (item) {
                return item.command === id
            });
            var values = models.map(function (model) {
                return {
                    id: model.model_system_name,
                    name: model.model_name_user + ":" + model.author,
                    selected: command.include.includes(model.id)
                }
            });
            appendToForm(id, {values: values})
        }

        function appendChangeInputSeriesOneModel(state) {
            var id = "change_input_series_one_model";
            var commands = state.filter(function (item) {
                return item.command === id
            });

            for (var command of commands) {
                var models_options = models.map(function (model) {
                    return {
                        id: model.model_system_name,
                        name: model.model_name_user + ":" + model.author,
                        selected: command.model_system_name === model.id
                    };
                });
                var series_initial_options = getInputs([command.model_system_name]).map(function (modelInput) {
                    return {
                        id: modelInput.series_name_system,
                        name: modelInput.series_name_user + ":" + modelInput.series_name_system,
                        selected: command.input_source_initial === modelInput.series_name_system
                    }
                });
                var series_final_options = getInputs().map(function (modelInput) {
                    return {
                        id: modelInput.series_name_system,
                        name: modelInput.series_name_user + ":" + modelInput.series_name_system,
                        selected: command.input_source_final === modelInput.series_name_system
                    }
                });
                appendToForm(id, {
                    models_options: models_options,
                    series_initial_options: series_initial_options,
                    series_final_options: series_final_options
                })
            }
        }

        function appendChangeInputSeriesAllModels(state) {
            var id = "change_input_series_all_models";
            var commands = state.filter(function (item) {
                return item.command === id
            });
            var exeModalsCommand = state.find(function (item) {
                return item.command === "exe_models"
            });

            for (var command of commands) {
                var series_initial_options = getInputs(exeModalsCommand.include).map(function (modelInput) {
                    return {
                        id: modelInput.series_name_system,
                        name: modelInput.series_name_user + ":" + modelInput.series_name_system,
                        selected: command.input_source_initial === modelInput.series_name_system
                    }
                });
                var series_final_options = getInputs().map(function (modelInput) {
                    return {
                        id: modelInput.series_name_system,
                        name: modelInput.series_name_user + ":" + modelInput.series_name_system,
                        selected: command.input_source_final === modelInput.series_name_system
                    }
                });
                appendToForm(id, {
                    series_initial_options: series_initial_options,
                    series_final_options: series_final_options
                })
            }
        }

        function appendChangeTimeseriesValueForSeveralDays(state) {
            var id = "change_timeseries_value_several_days";
            var commands = state.filter(function (item) {
                return item.command === id
            });

            for (var command of commands) {
                var series_all_options = getInputs().map(function (modelInput) {
                    return {
                        id: modelInput.series_name_system,
                        name: modelInput.series_name_user + ":" + modelInput.series_name_system,
                        selected: command.input_source_final === modelInput.series_name_system
                    }
                });
                appendToForm(id, {
                    series_all_options: series_all_options,
                    first_day: command.first_day,
                    number_of_days: command.number_of_days,
                    new_value: command.new_value
                })
            }
        }

        function appendChangeTimeseriesValueForSeveralDaysAddDelta(state) {
            var id = "change_timeseries_value_several_days_add_delta";
            var commands = state.filter(function (item) {
                return item.command === id
            });

            for (var command of commands) {
                var series_all_options = getInputs().map(function (modelInput) {
                    return {
                        id: modelInput.series_name_system,
                        name: modelInput.series_name_user + ":" + modelInput.series_name_system,
                        selected: command.input_source_final === modelInput.series_name_system
                    }
                });
                appendToForm(id, {
                    series_all_options: series_all_options,
                    first_day: command.first_day,
                    number_of_days: command.number_of_days,
                    delta: command.delta
                })
            }
        }

        $(function () {
            renderForm(state);

            /*
            $("#form_run").submit(function (event) {
                event.preventDefault();

                var formData = $(this).serializeArray();
                constructCommands(formData)
            });
            */
        })
    </script>

    {% raw %}
    <script data-template="start_day" type="text/x-handlebars-template">
        <div class="form-group row">
            <label for="start_day" class="col-sm-2 col-form-label">Start day</label>
            <div class="col-auto">
                <input type="date" class="form-control" id="start_day" name="start_day" value="{{ value }}">
            </div>
        </div>
    </script>

    <script data-template="number_of_days" type="text/x-handlebars-template">
        <div class="form-group row">
            <label for="number_of_days" class="col-sm-2 col-form-label">Number of days</label>
            <div class="col-auto">
                <input type="number" class="form-control" id="number_of_days" name="number_of_days" value="{{ value }}">
            </div>
        </div>
    </script>

    <script data-template="exe_models" type="text/x-handlebars-template">
        <div class="form-group row">
            <label for="exe_models" class="col-sm-2 col-form-label">Exec models</label>
            <div class="col-auto">
                <select id="exe_models" name="exe_models" class="form-control" multiple>
                    {{#each values}}
                    {{#if selected }}
                    <option value="{{ id }}" selected>{{name}}</option>
                    {{else}}
                    <option value="{{ id }}">{{name}}</option>
                    {{/if}}
                    {{/each}}
                </select>
            </div>
        </div>
    </script>

    <script data-template="change_input_series_one_model" type="text/x-handlebars-template">
        <div class="form-group row">
            <label for="change_input_series_one_model_name" class="col-sm-2 col-form-label">Change input series one
                model</label>
            <div class="col-auto">
                <div class="form-inline">
                    <label for="change_input_series_one_model_initial" class="mr-2">Initial</label>
                    <select id="change_input_series_one_model_initial" name="change_input_series_one_model_initial"
                            class="form-control">
                        {{#each series_initial_options}}
                        {{#if selected }}
                        <option value="{{ id }}" selected>{{name}}</option>
                        {{else}}
                        <option value="{{ id }}">{{name}}</option>
                        {{/if}}
                        {{/each}}
                    </select>
                    <label for="change_input_series_one_model_final" class="mx-2">Final</label>
                    <select id="change_input_series_one_model_final" name="change_input_series_one_model_final"
                            class="form-control mr-4">
                        {{#each series_final_options}}
                        {{#if selected }}
                        <option value="{{ id }}" selected>{{name}}</option>
                        {{else}}
                        <option value="{{ id }}">{{name}}</option>
                        {{/if}}
                        {{/each}}
                    </select>
                    <select id="change_input_series_one_model_name" name="change_input_series_one_model_name"
                            class="form-control">
                        {{#each models_options}}
                        {{#if selected }}
                        <option value="{{ id }}" selected>{{name}}</option>
                        {{else}}
                        <option value="{{ id }}">{{name}}</option>
                        {{/if}}
                        {{/each}}
                    </select>
                </div>
            </div>
        </div>
    </script>

    <script data-template="change_input_series_all_models" type="text/x-handlebars-template">
        <div class="form-group row">
            <label for="change_input_series_all_models_name" class="col-sm-2 col-form-label">Change input series all
                models</label>
            <div class="col-auto">
                <div class="form-inline">
                    <label for="change_input_series_all_models_initial" class="mr-2">Initial</label>
                    <select id="change_input_series_all_models_initial" name="change_input_series_all_models_initial"
                            class="form-control">
                        {{#each series_initial_options}}
                        {{#if selected }}
                        <option value="{{ id }}" selected>{{name}}</option>
                        {{else}}
                        <option value="{{ id }}">{{name}}</option>
                        {{/if}}
                        {{/each}}
                    </select>
                    <label for="change_input_series_all_models_final" class="mx-2">Final</label>
                    <select id="change_input_series_all_models_final" name="change_input_series_one_model_final"
                            class="form-control">
                        {{#each series_final_options}}
                        {{#if selected }}
                        <option value="{{ id }}" selected>{{name}}</option>
                        {{else}}
                        <option value="{{ id }}">{{name}}</option>
                        {{/if}}
                        {{/each}}
                    </select>
                </div>
            </div>
        </div>
    </script>

    <script data-template="change_timeseries_value_several_days" type="text/x-handlebars-template">
        <div class="form-group row">
            <label for="change_timeseries_value_several_days" class="col-sm-2 col-form-label">Change timeseries
                value for several days</label>
            <div class="col-auto">
                <div class="form-inline">
                    <label for="change_timeseries_value_several_days" class="mr-2">Series</label>
                    <select id="change_timeseries_value_several_days"
                            name="change_timeseries_value_several_days"
                            class="form-control">
                        {{#each series_all_options}}
                        {{#if selected }}
                        <option value="{{ id }}" selected>{{name}}</option>
                        {{else}}
                        <option value="{{ id }}">{{name}}</option>
                        {{/if}}
                        {{/each}}
                    </select>
                    <label for="change_timeseries_value_several_days_first_day" class="mx-2">First day</label>
                    <input type="date" class="form-control" id="change_timeseries_value_several_days_first_day"
                           name="change_timeseries_value_several_days_first_day" value="{{ first_day }}">
                    <label for="change_timeseries_value_several_days_number_of_days" class="mx-2">Number of
                        days</label>
                    <input type="number" class="form-control"
                           id="change_timeseries_value_several_days_number_of_days"
                           name="change_timeseries_value_several_days_number_of_days" value="{{ number_of_days }}">
                    <label for="change_timeseries_value_several_days_new_value" class="mx-2">New value</label>
                    <input type="text" class="form-control" id="change_timeseries_value_several_days_new_value"
                           name="change_timeseries_value_several_days_new_value" value="{{ new_value }}">
                </div>
            </div>
        </div>
    </script>

    <script data-template="change_timeseries_value_several_days_add_delta" type="text/x-handlebars-template">
        <div class="form-group row">
            <label for="change_timeseries_value_several_days_add_delta" class="col-sm-2 col-form-label">Change
                timeseries value several days add delta</label>
            <div class="col-auto">
                <div class="form-inline">
                    <label for="change_timeseries_value_several_days_add_delta" class="mr-2">Series</label>
                    <select id="change_timeseries_value_several_days_add_delta"
                            name="change_timeseries_value_several_days_add_delta"
                            class="form-control">
                        {{#each series_all_options}}
                        {{#if selected }}
                        <option value="{{ id }}" selected>{{name}}</option>
                        {{else}}
                        <option value="{{ id }}">{{name}}</option>
                        {{/if}}
                        {{/each}}
                    </select>
                    <label for="change_timeseries_value_several_days_add_delta_first_day" class="mx-2">First
                        day</label>
                    <input type="date" class="form-control"
                           id="change_timeseries_value_several_days_add_delta_first_day"
                           name="change_timeseries_value_several_days_add_delta_first_day" value="{{ first_day }}">
                    <label for="change_timeseries_value_several_days_add_delta_number_of_days" class="mx-2">Number
                        of
                        days</label>
                    <input type="number" class="form-control"
                           id="change_timeseries_value_several_days_add_delta_number_of_days"
                           name="change_timeseries_value_several_days_add_delta_number_of_days"
                           value="{{ number_of_days }}">
                    <label for="change_timeseries_value_several_days_add_delta_delta" class="mx-2">Delta</label>
                    <input type="text" class="form-control"
                           id="change_timeseries_value_several_days_add_delta_delta"
                           name="change_timeseries_value_several_days_add_delta_delta" value="{{ delta }}">
                </div>
            </div>
        </div>
    </script>
    {% endraw %}
{% endblock %}

{% block content %}
    <h1>Run modeling</h1>
    <form id="form_run">
        <div id="form_commands">
        </div>
        <div class="form-group row">
            <div class="col-auto">
                <button type="submit" class="btn btn-primary mb-2">Submit</button>
            </div>
        </div>
    </form>
{% endblock %}